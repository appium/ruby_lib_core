steps:
- task: NodeTool@0
  inputs:
    versionSpec: 18.x
  displayName: Install Node 18.x to get NPM v8
- script: npm install -g appium@${APPIUM_VERSION}
  displayName: Install appium
- script: npm install -g mjpeg-consumer
  displayName: Install MJPEG Consumer
- script: npm list --depth 2 -g || echo 'ok'
  displayName: Installed node dependencies
- script: |
    # git clone https://github.com/mykola-mokhnach/appium-espresso-driver.git
    git clone https://github.com/appium/appium-android-driver.git
    cd appium-android-driver
    git checkout fix-createbaseadb
    npm install
    npm link

    git clone https://github.com/appium/appium-uiautomator2-driver.git
    cd appium-uiautomator2-driver
    npm install
- script: ls
- script: appium driver install --source=local $(pwd)/appium-uiautomator2-driver
  displayName: Install appium driver ${APPIUM_DRIVER}
  env:
    APPIUM_HOME: $(Agent.HomeDirectory)/appium
- script: |
    cd appium-uiautomator2-driver
    npm link appium-android-driver
- script: appium plugin install images
  displayName: Install appium images plugin
  env:
    APPIUM_HOME: $(Agent.HomeDirectory)/appium
- script: appium plugin install execute-driver
  displayName: Install appium execute-driver plugin
  env:
    APPIUM_HOME: $(Agent.HomeDirectory)/appium
- task: UseRubyVersion@0
  inputs:
    versionSpec: '>= 3.0'
- script: |
    mkdir -p test/report
    nohup appium --use-plugins=images,execute-driver --relaxed-security --log-timestamp --log-no-colors --base-path=/wd/hub > test/report/appium.out 2>&1 &
  displayName: Run Appium in background
  env:
    JAVA_HOME: $(JAVA_HOME_11_X64)
    PATH: $(JAVA_HOME_11_X64)/bin:$(PATH)
    APPIUM_HOME: $(Agent.HomeDirectory)/appium
- script: |
    gem install bundler;
    bundle install --retry=3 --jobs=4 --path vendor/bundle;
  displayName: Install Gems
